name: Security Checks

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main, develop ]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  security-audit:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Verify package-lock.json
        run: |
          if [ ! -f package-lock.json ]; then
            echo "ERROR: package-lock.json not found"
            exit 1
          fi

      - name: Clean install dependencies
        run: npm ci

      - name: Run npm audit
        run: npm audit --audit-level=moderate
        continue-on-error: false

      - name: Check for Shai-Hulud malware
        run: |
          echo "Scanning for malware signatures..."

          # Check for malicious files
          if find . -name "setup_bun.js" -o -name "bun_environment.js" | grep -q .; then
            echo "ERROR: Malicious files detected!"
            exit 1
          fi

          # Check for malicious patterns
          if grep -r "Sha1-Hulud\|Shai-Hulud\|The Second Coming" . --exclude-dir=node_modules --exclude-dir=.git 2>/dev/null | grep -q .; then
            echo "ERROR: Malicious code patterns detected!"
            exit 1
          fi

          echo "No malware signatures found"

      - name: Check for suspicious preinstall scripts
        run: |
          echo "Checking for suspicious lifecycle scripts..."
          PREINSTALL_COUNT=$(grep -r '"preinstall"' node_modules/*/package.json 2>/dev/null | grep -v "node_modules/.bin" | wc -l || echo "0")

          if [ "$PREINSTALL_COUNT" -gt 0 ]; then
            echo "WARNING: Found $PREINSTALL_COUNT packages with preinstall scripts"
            grep -r '"preinstall"' node_modules/*/package.json 2>/dev/null | grep -v "node_modules/.bin"
          else
            echo "No suspicious preinstall scripts found"
          fi

      - name: Snyk Security Scan
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high

  dependency-review:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: moderate
